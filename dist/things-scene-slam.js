!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("@hatiolab/things-scene")):"function"==typeof define&&define.amd?define(["exports","@hatiolab/things-scene"],e):e((t=t||self)["things-scene-slam"]={},t.scene)}(this,function(t,e){"use strict";class i extends(e.RectPath(e.Shape)){_pre_draw(t){if(this.get("trace")){var e=this.center;t.beginPath();var i=this.trace.length;this.trace.forEach(function(e,s){0==s?t.moveTo(e.x,e.y):s<i-1&&t.lineTo(e.x,e.y)}),t.lineTo(e.x+this.delta("tx"),e.y+this.delta("ty")),t.strokeStyle=this.get("strokeStyle"),t.stroke()}super._pre_draw(t)}_draw(t){var{top:e,left:i,width:s,height:h,strokeStyle:o}=this.model,r=this.center;t.beginPath(),t.moveTo(r.x,e+h/4),t.lineTo(i+s,e),t.lineTo(r.x,e+h),t.lineTo(i,e),t.lineTo(r.x,e+h/4)}is3dish(){return!1}get hasTextProperty(){return!1}get trace(){return this._trace||(this._trace=[]),this._trace}onchange(t,e){var i=t.hasOwnProperty("left"),s=t.hasOwnProperty("top"),h=t.hasOwnProperty("rotation");if(i||s||h){var o=this;if(i&&(this.dx=t.left-e.left),s&&(this.dy=t.top-e.top),(i||s)&&this.trace.push(this.center),h){var r=t.rotation%(2*Math.PI);r<-Math.PI&&(r+=2*Math.PI),r>Math.PI&&(r-=2*Math.PI);var a=(e.rotation||0)%(2*Math.PI);a<-Math.PI&&(a+=2*Math.PI),a>Math.PI&&(a-=2*Math.PI),this.dtheta=r-a,this.dtheta>Math.PI?this.dtheta-=2*Math.PI:this.dtheta<-Math.PI&&(this.dtheta+=2*Math.PI)}this.dx&&this.delta("tx",-this.dx),this.dy&&this.delta("ty",-this.dy),this.dtheta&&this.delta("theta",-this.dtheta),this.animate({step:function(t){o.dx&&o.delta("tx",-o.dx*(1-t)),o.dy&&o.delta("ty",-o.dy*(1-t)),o.dtheta&&o.delta("theta",-o.dtheta*(1-t)),o.invalidate(),t>=1&&(delete o.dx,delete o.dy,delete o.dtheta)},delta:"linear"}).start()}}}e.Component.register("mo",i);const s=0,h=1,o=2,r=3,a=Math.PI/4;function n(t,e){var i=Math.atan2(t.y-e.y,e.x-t.x);return-a<i&&a>=i?h:a<i&&3*a>=i?s:3*a<i||3*-a>=i?r:o}class l extends e.Ellipse{_draw_count(t,i,s,h,o,r,a){a=a/2+a/2*o/(h||1),t.font=e.Component.font({fontFamily:r,fontSize:a}),t.fillText(String(o),i,s+a/2)}_draw_inout(t){var{fontFamily:i=e.DEFAULT.FONT_FAMILY,fontSize:s=20}=this.model,h=this.bounds,o=this.outs.reduce((t,e)=>t+e,0);t.fillStyle="navy",this._draw_count(t,h.left+h.width/2,h.top-20,o,this.outs[0],i,s),this._draw_count(t,h.left+h.width+10,h.top+h.height/2,o,this.outs[1],i,s),this._draw_count(t,h.left+h.width/2,h.top+h.height+20,o,this.outs[2],i,s),this._draw_count(t,h.left-30,h.top+h.height/2,o,this.outs[3],i,s),o=this.ins.reduce((t,e)=>t+e,0),t.fillStyle="red",this._draw_count(t,h.left+h.width/2,h.top+20,o,this.ins[0],i,s),this._draw_count(t,h.left+h.width-30,h.top+h.height/2,o,this.ins[1],i,s),this._draw_count(t,h.left+h.width/2,h.top+h.height-20,o,this.ins[2],i,s),this._draw_count(t,h.left+10,h.top+h.height/2,o,this.ins[3],i,s)}_post_draw(t){super._post_draw(t),this._draw_arrows(t),this._draw_inout(t)}is3dish(){return!1}get count(){return this.molist.length}get text(){return String(this.molist.length)}get outs(){return this._outs||(this._outs=[0,0,0,0]),this._outs}get ins(){return this._ins||(this._ins=[0,0,0,0]),this._ins}get molist(){return this._molist||(this._molist=[]),this._molist}_in(t){-1==this.molist.indexOf(t)&&(this.molist.push(t),this.ins[n(this.center,t.center)]++)}_out(t){var e=this.molist.indexOf(t);-1!==e&&(this.molist.splice(e,1),this.outs[n(this.center,t.center)]++)}_draw_arrows(t){for(var e=0;e<4;e++){var i=this._caculateArrowSizeAmplifier(e);this._draw_arrow(t,i,e)}}_draw_arrow(t,e,i){var s=Math.PI/2*i,h=this.center,{left:o,top:r,width:a,height:n}=this.bounds,l=a,d=n;i%2==1&&(d=a,l=n);var _=.5*l,u=.25*d*e;t.translate(h.x,h.y),t.rotate(s),t.beginPath(),t.fillStyle="green",t.moveTo(0,-.5*d-u),t.lineTo(.5*_,-.5*d-.5*u),t.lineTo(.25*_,-.5*d-.5*u),t.lineTo(.25*_,-.5*d),t.lineTo(-.25*_,-.5*d),t.lineTo(-.25*_,-.5*d-.5*u),t.lineTo(-.5*_,-.5*d-.5*u),t.lineTo(0,-.5*d-u),t.moveTo(h.x,h.y),t.fill(),t.closePath(),t.rotate(-s),t.translate(-h.x,-h.y)}_caculateArrowSizeAmplifier(t){var e=1+this.outs[t]/(this.outs.reduce((t,e)=>t+e,0)||1);return e>1.4?1.4:e}get eventMap(){return{"(root)":{mo:{change:this.onchange_mo,removed:this.onremove_mo}}}}onchange_mo(t,e,i){if(t.hasOwnProperty("left")||t.hasOwnProperty("top")){var{origin:s,deliverer:h}=i,o=s.center;this.contains(o.x,o.y)?this._in(s):this._out(s)}}onremove_mo(t,e){this._out(e)}}e.Component.register("landmark",l),t.Mo=i,t.Landmark=l,Object.defineProperty(t,"__esModule",{value:!0})});
