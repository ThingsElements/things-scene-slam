import{RectPath as t,Shape as e,Component as i,Ellipse as h,DEFAULT as s}from"@hatiolab/things-scene";class r extends(t(e)){_pre_draw(t){if(this.get("trace")){var e=this.center;t.beginPath();var i=this.trace.length;this.trace.forEach(function(e,h){0==h?t.moveTo(e.x,e.y):h<i-1&&t.lineTo(e.x,e.y)}),t.lineTo(e.x+this.delta("tx"),e.y+this.delta("ty")),t.strokeStyle=this.get("strokeStyle"),t.stroke()}super._pre_draw(t)}_draw(t){var{top:e,left:i,width:h,height:s,strokeStyle:r}=this.model,o=this.center;t.beginPath(),t.moveTo(o.x,e+s/4),t.lineTo(i+h,e),t.lineTo(o.x,e+s),t.lineTo(i,e),t.lineTo(o.x,e+s/4)}is3dish(){return!1}get hasTextProperty(){return!1}get trace(){return this._trace||(this._trace=[]),this._trace}onchange(t,e){var i=t.hasOwnProperty("left"),h=t.hasOwnProperty("top"),s=t.hasOwnProperty("rotation");if(i||h||s){var r=this;if(i&&(this.dx=t.left-e.left),h&&(this.dy=t.top-e.top),(i||h)&&this.trace.push(this.center),s){var o=t.rotation%(2*Math.PI);o<-Math.PI&&(o+=2*Math.PI),o>Math.PI&&(o-=2*Math.PI);var a=(e.rotation||0)%(2*Math.PI);a<-Math.PI&&(a+=2*Math.PI),a>Math.PI&&(a-=2*Math.PI),this.dtheta=o-a,this.dtheta>Math.PI?this.dtheta-=2*Math.PI:this.dtheta<-Math.PI&&(this.dtheta+=2*Math.PI)}this.dx&&this.delta("tx",-this.dx),this.dy&&this.delta("ty",-this.dy),this.dtheta&&this.delta("theta",-this.dtheta),this.animate({step:function(t){r.dx&&r.delta("tx",-r.dx*(1-t)),r.dy&&r.delta("ty",-r.dy*(1-t)),r.dtheta&&r.delta("theta",-r.dtheta*(1-t)),r.invalidate(),t>=1&&(delete r.dx,delete r.dy,delete r.dtheta)},delta:"linear"}).start()}}}i.register("mo",r);const o=0,a=1,n=2,l=3,d=Math.PI/4;function _(t,e){var i=Math.atan2(t.y-e.y,e.x-t.x);return-d<i&&d>=i?a:d<i&&3*d>=i?o:3*d<i||3*-d>=i?l:n}class u extends h{_draw_count(t,e,h,s,r,o,a){a=a/2+a/2*r/(s||1),t.font=i.font({fontFamily:o,fontSize:a}),t.fillText(String(r),e,h+a/2)}_draw_inout(t){var{fontFamily:e=s.FONT_FAMILY,fontSize:i=20}=this.model,h=this.bounds,r=this.outs.reduce((t,e)=>t+e,0);t.fillStyle="navy",this._draw_count(t,h.left+h.width/2,h.top-20,r,this.outs[0],e,i),this._draw_count(t,h.left+h.width+10,h.top+h.height/2,r,this.outs[1],e,i),this._draw_count(t,h.left+h.width/2,h.top+h.height+20,r,this.outs[2],e,i),this._draw_count(t,h.left-30,h.top+h.height/2,r,this.outs[3],e,i),r=this.ins.reduce((t,e)=>t+e,0),t.fillStyle="red",this._draw_count(t,h.left+h.width/2,h.top+20,r,this.ins[0],e,i),this._draw_count(t,h.left+h.width-30,h.top+h.height/2,r,this.ins[1],e,i),this._draw_count(t,h.left+h.width/2,h.top+h.height-20,r,this.ins[2],e,i),this._draw_count(t,h.left+10,h.top+h.height/2,r,this.ins[3],e,i)}_post_draw(t){super._post_draw(t),this._draw_arrows(t),this._draw_inout(t)}is3dish(){return!1}get count(){return this.molist.length}get text(){return String(this.molist.length)}get outs(){return this._outs||(this._outs=[0,0,0,0]),this._outs}get ins(){return this._ins||(this._ins=[0,0,0,0]),this._ins}get molist(){return this._molist||(this._molist=[]),this._molist}_in(t){-1==this.molist.indexOf(t)&&(this.molist.push(t),this.ins[_(this.center,t.center)]++)}_out(t){var e=this.molist.indexOf(t);-1!==e&&(this.molist.splice(e,1),this.outs[_(this.center,t.center)]++)}_draw_arrows(t){for(var e=0;e<4;e++){var i=this._caculateArrowSizeAmplifier(e);this._draw_arrow(t,i,e)}}_draw_arrow(t,e,i){var h=Math.PI/2*i,s=this.center,{left:r,top:o,width:a,height:n}=this.bounds,l=a,d=n;i%2==1&&(d=a,l=n);var _=.5*l,u=.25*d*e;t.translate(s.x,s.y),t.rotate(h),t.beginPath(),t.fillStyle="green",t.moveTo(0,-.5*d-u),t.lineTo(.5*_,-.5*d-.5*u),t.lineTo(.25*_,-.5*d-.5*u),t.lineTo(.25*_,-.5*d),t.lineTo(-.25*_,-.5*d),t.lineTo(-.25*_,-.5*d-.5*u),t.lineTo(-.5*_,-.5*d-.5*u),t.lineTo(0,-.5*d-u),t.moveTo(s.x,s.y),t.fill(),t.closePath(),t.rotate(-h),t.translate(-s.x,-s.y)}_caculateArrowSizeAmplifier(t){var e=1+this.outs[t]/(this.outs.reduce((t,e)=>t+e,0)||1);return e>1.4?1.4:e}get eventMap(){return{"(root)":{mo:{change:this.onchange_mo,removed:this.onremove_mo}}}}onchange_mo(t,e,i){if(t.hasOwnProperty("left")||t.hasOwnProperty("top")){var{origin:h,deliverer:s}=i,r=h.center;this.contains(r.x,r.y)?this._in(h):this._out(h)}}onremove_mo(t,e){this._out(e)}}i.register("landmark",u);export{r as Mo,u as Landmark};
